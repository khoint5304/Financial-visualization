<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0" />
    <title>Stock Chart & Company Info</title>
    <script type="text/javascript"
        src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body {
            padding: 0;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f7f9fa;
        }

        .controls {
            padding: 10px;
            background-color: #ffffff;
            border-bottom: 1px solid #e0e3eb;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }

        .controls input,
        .controls select,
        .controls button {
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .controls button {
            background-color: #2962FF;
            color: white;
            border-color: #2962FF;
            cursor: pointer;
            font-weight: 500;
        }

        .controls button:hover {
            background-color: #1e4dbb;
        }

        #statusMessage {
            margin-left: 10px;
            font-style: italic;
            color: #666;
        }

        .main-content {
            display: flex;
            flex-direction: row;
            flex-grow: 1;
            overflow: hidden;
        }

        #chartContainer {
            flex: 3;
            position: relative;
        }

        #infoContainer {
            flex: 1;
            padding: 15px;
            background-color: #ffffff;
            border-left: 1px solid #e0e3eb;
            overflow-y: auto;
        }

        .info-section {
            margin-bottom: 20px;
        }

        .info-section summary {
            font-weight: 600;
            font-size: 16px;
            padding: 10px;
            cursor: pointer;
            background-color: #f1f3f6;
            border-radius: 4px;
            list-style: none;
        }

        .info-section summary::-webkit-details-marker {
            display: none;
        }

        .info-section summary::before {
            content: '‚ñ∂';
            margin-right: 8px;
            font-size: 12px;
            display: inline-block;
            transition: transform 0.2s;
        }

        .info-section[open]>summary::before {
            transform: rotate(90deg);
        }

        .info-content {
            padding-top: 10px;
        }

        .info-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            overflow-x: auto;
            display: block;
        }



        .info-table th,
        .info-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            white-space: nowrap;
        }

        .info-table th {
            background-color: #f8f8f8;
            font-weight: 500;
            text-align: center;
        }

        .info-table tbody td {
            text-align: right;
        }

        .info-table tbody td:first-child {
            text-align: left;
        }

        .info-table tr:nth-child(even) {
            background-color: #fdfdfd;
        }

        .period-toggle {
            margin-bottom: 10px;
            font-size: 14px;
        }

        .period-toggle label {
            margin: 0 10px 0 2px;
            cursor: pointer;
        }

        #chart-legend {
            position: absolute;
            top: 12px;
            left: 50px;
            z-index: 100;
            font-size: 14px;
            font-family: monospace;
            display: none;
            pointer-events: none;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #e0e3eb;
        }

        #drawing-toolbar {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 200;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            border: 1px solid #e0e3eb;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #drawing-toolbar button {
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 8px;
            font-size: 20px;
            line-height: 1;
            border-bottom: 1px solid #f1f3f6;
        }

        #drawing-toolbar button:last-child {
            border-bottom: none;
        }

        #drawing-toolbar button:hover {
            background-color: #f1f3f6;
        }

        #drawing-toolbar button.active {
            background-color: #e0e3eb;
        }
    </style>
</head>

<body>
    <div class="controls">
        <label for="stockCodeInput">M√£ CP:</label>
        <input type="text" id="stockCodeInput" placeholder="VD: FPT" value="FPT" size="6">

        <label for="intervalSelect">Khung TG:</label>
        <select id="intervalSelect"></select>

        <button id="loadChartButton">T·∫£i D·ªØ Li·ªáu</button>
        <span id="statusMessage"></span>
    </div>

    <div class="main-content">
        <div id="chartContainer">
            <div id="drawing-toolbar">
                <button id="tool-cursor" title="Cursor">üëÜ</button>
                <button id="tool-trendline" title="Trend Line">üìà</button>
                <button id="tool-delete" title="Delete Last Drawing">üóëÔ∏è</button>
            </div>
            <div id="chart-legend"></div>
        </div>
        <div id="infoContainer">
            <h2 id="company-title" style="margin-top: 0;">Th√¥ng tin C√¥ng ty</h2>

            <details class="info-section" open>
                <summary>T·ªïng quan</summary>
                <div class="info-content" id="overview-content"></div>
            </details>

            <details class="info-section">
                <summary>C·ªï ƒë√¥ng l·ªõn</summary>
                <div class="info-content" id="shareholders-content"></div>
            </details>

            <details class="info-section">
                <summary>Ban l√£nh ƒë·∫°o</summary>
                <div class="info-content" id="officers-content"></div>
            </details>

            <details class="info-section">
                <summary>C√¥ng ty con & Li√™n k·∫øt</summary>
                <div class="info-content" id="subsidiaries-content"></div>
            </details>

            <details class="info-section">
                <summary>B√°o c√°o K·∫øt qu·∫£ Kinh doanh</summary>
                <div class="info-content" id="kqkd-content-wrapper">
                    <div class="period-toggle">
                        <input type="radio" id="kqkd-year" name="kqkd-period" value="year" checked>
                        <label for="kqkd-year">NƒÉm</label>
                        <input type="radio" id="kqkd-quarter" name="kqkd-period" value="quarter">
                        <label for="kqkd-quarter">Qu√Ω</label>
                    </div>
                    <div id="kqkd-content"></div>
                </div>
            </details>

            <details class="info-section">
                <summary>Ch·ªâ s·ªë T√†i ch√≠nh</summary>
                <div class="info-content" id="cstc-content-wrapper">
                    <div class="period-toggle">
                        <input type="radio" id="cstc-year" name="cstc-period" value="year" checked>
                        <label for="cstc-year">NƒÉm</label>
                        <input type="radio" id="cstc-quarter" name="cstc-period" value="quarter">
                        <label for="cstc-quarter">Qu√Ω</label>
                    </div>
                    <div id="cstc-content"></div>
                </div>
            </details>

            <details class="info-section">
                <summary>L∆∞u chuy·ªÉn Ti·ªÅn t·ªá</summary>
                <div class="info-content" id="lctt-content-wrapper">
                    <div class="period-toggle">
                        <input type="radio" id="lctt-year" name="lctt-period" value="year" checked>
                        <label for="lctt-year">NƒÉm</label>
                        <input type="radio" id="lctt-quarter" name="lctt-period" value="quarter">
                        <label for="lctt-quarter">Qu√Ω</label>
                    </div>
                    <div id="lctt-content"></div>
                </div>
            </details>

            <details class="info-section">
                <summary>Tin t·ª©c m·ªõi nh·∫•t</summary>
                <div class="info-content" id="news-content"></div>
            </details>
        </div>
    </div>

    <script type="text/javascript">
        const chartContainer = document.getElementById('chartContainer');
        const infoContainer = document.getElementById('infoContainer');
        const companyTitle = document.getElementById('company-title');
        const stockCodeInput = document.getElementById('stockCodeInput');
        const intervalSelect = document.getElementById('intervalSelect');
        const loadChartButton = document.getElementById('loadChartButton');
        const statusMessage = document.getElementById('statusMessage');
        const chartLegend = document.getElementById('chart-legend');

        let chart = null;
        let candlestickSeries = null;
        let volumeSeries = null;
        let maSeries = null;
        const SUPPORTED_INTERVALS = ['1h', '1D', '1W', '1M'];
        const DEFAULT_INTERVAL = '1D';

        let currentDrawingTool = 'cursor';
        let isDrawing = false;
        let startPoint = null;
        let currentDrawing = null;
        let allTrendLines = [];

        function renderCompanyProfile(csvUrl, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '<p>ƒêang t·∫£i...</p>';

            const urlWithCacheBusting = `${csvUrl}?t=${new Date().getTime()}`;

            fetch(urlWithCacheBusting)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Kh√¥ng t√¨m th·∫•y file: ${csvUrl.split('/').pop().split('?')[0]}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            if (results.errors.length > 0 || results.data.length === 0) {
                                container.innerHTML = '<p>Kh√¥ng c√≥ d·ªØ li·ªáu t·ªïng quan.</p>';
                                return;
                            }

                            const profileData = results.data[0];
                            const companyProfile = profileData.company_profile || 'Ch∆∞a c√≥ th√¥ng tin.';
                            const industry = profileData.icb_name2 || 'Ch∆∞a c√≥ th√¥ng tin.';

                            let profileHTML = `<p style="text-align: justify; line-height: 1.6; font-size: 14px;">${companyProfile}</p>`;
                            profileHTML += `<p style="font-size: 14px;"><strong>Ng√†nh:</strong> ${industry}</p>`;

                            container.innerHTML = profileHTML;
                        }
                    });
                })
                .catch(error => {
                    console.error(`L·ªói khi t·∫£i ${containerId}:`, error);
                    container.innerHTML = `<p style="color: red;">${error.message}</p>`;
                });
        }

        function renderShareholdersTable(csvUrl, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '<p>ƒêang t·∫£i...</p>';

            const urlWithCacheBusting = `${csvUrl}?t=${new Date().getTime()}`;

            fetch(urlWithCacheBusting)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Kh√¥ng t√¨m th·∫•y file: ${csvUrl.split('/').pop().split('?')[0]}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            if (results.errors.length > 0 || results.data.length === 0) {
                                container.innerHTML = '<p>Kh√¥ng c√≥ d·ªØ li·ªáu.</p>';
                                return;
                            }
                            const data = results.data;

                            let tableHTML = '<table class="info-table"><thead><tr>';
                            tableHTML += '<th>C·ªï ƒë√¥ng</th>';
                            tableHTML += '<th>S·ªë l∆∞·ª£ng c·ªï phi·∫øu</th>';
                            tableHTML += '<th>T·ªâ l·ªá c·ªï phi·∫øu</th>';
                            tableHTML += '<th>Ng√†y c·∫≠p nh·∫≠t</th>';
                            tableHTML += '</tr></thead><tbody>';

                            data.forEach(row => {
                                const quantity = parseFloat(row.quantity);
                                const percent = parseFloat(row.share_own_percent);
                                tableHTML += '<tr>';
                                tableHTML += `<td>${row.share_holder || ''}</td>`;
                                tableHTML += `<td>${!isNaN(quantity) ? quantity.toLocaleString('vi-VN') : ''}</td>`;
                                tableHTML += `<td>${!isNaN(percent) ? (percent * 100).toFixed(2) + '%' : ''}</td>`;
                                tableHTML += `<td>${row.update_date || ''}</td>`;
                                tableHTML += '</tr>';
                            });

                            tableHTML += '</tbody></table>';
                            container.innerHTML = tableHTML;
                        }
                    });
                })
                .catch(error => {
                    console.error(`L·ªói khi t·∫£i ${containerId}:`, error);
                    container.innerHTML = `<p style="color: red;">${error.message}</p>`;
                });
        }

        function renderOfficersTable(csvUrl, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '<p>ƒêang t·∫£i...</p>';

            const urlWithCacheBusting = `${csvUrl}?t=${new Date().getTime()}`;

            fetch(urlWithCacheBusting)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Kh√¥ng t√¨m th·∫•y file: ${csvUrl.split('/').pop().split('?')[0]}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            if (results.errors.length > 0 || results.data.length === 0) {
                                container.innerHTML = '<p>Kh√¥ng c√≥ d·ªØ li·ªáu.</p>';
                                return;
                            }
                            const data = results.data;

                            let tableHTML = '<table class="info-table"><thead><tr>';
                            tableHTML += '<th>T√™n</th>';
                            tableHTML += '<th>V·ªã tr√≠</th>';
                            tableHTML += '<th>S·ªë l∆∞·ª£ng</th>';
                            tableHTML += '<th>T·ªâ l·ªá s·ªü h·ªØu</th>';
                            tableHTML += '<th>Th·ªùi gian c·∫≠p nh·∫≠t</th>';
                            tableHTML += '</tr></thead><tbody>';

                            data.forEach(row => {
                                const quantity = parseFloat(row.quantity);
                                const percent = parseFloat(row.officer_own_percent);
                                tableHTML += '<tr>';
                                tableHTML += `<td>${row.officer_name || ''}</td>`;
                                tableHTML += `<td>${row.officer_position || ''}</td>`;
                                tableHTML += `<td>${!isNaN(quantity) ? quantity.toLocaleString('vi-VN') : ''}</td>`;
                                tableHTML += `<td>${!isNaN(percent) ? (percent * 100).toFixed(4) + '%' : ''}</td>`;
                                tableHTML += `<td>${row.update_date || ''}</td>`;
                                tableHTML += '</tr>';
                            });

                            tableHTML += '</tbody></table>';
                            container.innerHTML = tableHTML;
                        }
                    });
                })
                .catch(error => {
                    console.error(`L·ªói khi t·∫£i ${containerId}:`, error);
                    container.innerHTML = `<p style="color: red;">${error.message}</p>`;
                });
        }

        function renderSubsidiariesTable(csvUrl, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '<p>ƒêang t·∫£i...</p>';

            const urlWithCacheBusting = `${csvUrl}?t=${new Date().getTime()}`;

            fetch(urlWithCacheBusting)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Kh√¥ng t√¨m th·∫•y file: ${csvUrl.split('/').pop().split('?')[0]}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            if (results.errors.length > 0 || results.data.length === 0) {
                                container.innerHTML = '<p>Kh√¥ng c√≥ d·ªØ li·ªáu.</p>';
                                return;
                            }
                            const data = results.data;

                            let tableHTML = '<table class="info-table"><thead><tr>';
                            tableHTML += '<th>T√™n c√¥ng ty</th>';
                            tableHTML += '<th>Lo·∫°i</th>';
                            tableHTML += '<th>T·ªâ l·ªá s·ªü h·ªØu</th>';
                            tableHTML += '</tr></thead><tbody>';

                            data.forEach(row => {
                                const percent = parseFloat(row.ownership_percent);
                                tableHTML += '<tr>';
                                tableHTML += `<td>${row.organ_name || ''}</td>`;
                                tableHTML += `<td>${row.type || ''}</td>`;
                                tableHTML += `<td>${!isNaN(percent) ? (percent * 100).toFixed(2) + '%' : ''}</td>`;
                                tableHTML += '</tr>';
                            });

                            tableHTML += '</tbody></table>';
                            container.innerHTML = tableHTML;
                        }
                    });
                })
                .catch(error => {
                    console.error(`L·ªói khi t·∫£i ${containerId}:`, error);
                    container.innerHTML = `<p style="color: red;">${error.message}</p>`;
                });
        }

        function renderNewsList(csvUrl, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '<p>ƒêang t·∫£i...</p>';

            const urlWithCacheBusting = `${csvUrl}?t=${new Date().getTime()}`;

            fetch(urlWithCacheBusting)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Kh√¥ng t√¨m th·∫•y file: ${csvUrl.split('/').pop().split('?')[0]}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            if (results.errors.length > 0 || results.data.length === 0) {
                                container.innerHTML = '<p>Kh√¥ng c√≥ d·ªØ li·ªáu.</p>';
                                return;
                            }
                            const data = results.data;

                            let listHTML = '<ul style="padding-left: 20px; margin: 0; list-style-type: none;">';
                            data.forEach(row => {
                                const title = row.news_title;
                                const link = row.news_source_link;
                                if (title && link) {
                                    listHTML += `<li style="margin-bottom: 12px; font-size: 14px;"><a href="${link}" target="_blank" style="text-decoration: none; color: #0056b3;">${title}</a></li>`;
                                }
                            });
                            listHTML += '</ul>';
                            container.innerHTML = listHTML;
                        }
                    });
                })
                .catch(error => {
                    console.error(`L·ªói khi t·∫£i ${containerId}:`, error);
                    container.innerHTML = `<p style="color: red;">${error.message}</p>`;
                });
        }

        function renderFinancialReport(stockCode, reportAbbr, containerId) {
            const period = document.querySelector(`input[name="${reportAbbr}-period"]:checked`).value;
            const filename = `Data/${stockCode}_${reportAbbr}_${period}.csv`;
            renderFinancialTable(filename, containerId);
        }

        function renderFinancialTable(csvUrl, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '<p>ƒêang t·∫£i...</p>';

            const urlWithCacheBusting = `${csvUrl}?t=${new Date().getTime()}`;

            fetch(urlWithCacheBusting)
                .then(response => {
                    if (!response.ok) { throw new Error(`Kh√¥ng t√¨m th·∫•y file: ${csvUrl.split('/').pop().split('?')[0]}`); }
                    return response.text();
                })
                .then(csvText => {
                    Papa.parse(csvText, {
                        header: false,
                        skipEmptyLines: true,
                        complete: (results) => {
                            const allRows = results.data;
                            if (allRows.length < 2) {
                                container.innerHTML = '<p>Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá.</p>';
                                return;
                            }

                            const categoryHeaders = allRows[0];
                            const metricHeaders = allRows[1];
                            const dataRows = allRows.slice(2);

                            const processedCategories = [];
                            if (categoryHeaders.length > 0) {
                                let currentCategory = categoryHeaders[0];
                                let count = 1;
                                for (let i = 1; i < categoryHeaders.length; i++) {
                                    if (categoryHeaders[i] === currentCategory) {
                                        count++;
                                    } else {
                                        processedCategories.push({ name: currentCategory, colspan: count });
                                        currentCategory = categoryHeaders[i];
                                        count = 1;
                                    }
                                }
                                processedCategories.push({ name: currentCategory, colspan: count });
                            }

                            let tableHTML = '<table class="info-table"><thead>';
                            tableHTML += '<tr>';
                            processedCategories.forEach(cat => {
                                tableHTML += `<th colspan="${cat.colspan}">${cat.name}</th>`;
                            });
                            tableHTML += '</tr>';

                            tableHTML += '<tr>';
                            metricHeaders.forEach(header => {
                                tableHTML += `<th>${header}</th>`;
                            });
                            tableHTML += '</tr></thead><tbody>';

                            dataRows.forEach(row => {
                                tableHTML += '<tr>';
                                row.forEach(cell => {
                                    tableHTML += `<td>${cell || ''}</td>`;
                                });
                                tableHTML += '</tr>';
                            });

                            tableHTML += '</tbody></table>';
                            container.innerHTML = tableHTML;
                        }
                    });
                })
                .catch(error => {
                    console.error(`L·ªói khi t·∫£i ${containerId}:`, error);
                    container.innerHTML = `<p style="color: red;">${error.message}</p>`;
                });
        }

        function calculateMovingAverageSeriesData(candleData, maLength) {
            const maData = [];
            for (let i = 0; i < candleData.length; i++) {
                if (i < maLength) {
                    maData.push({ time: candleData[i].time });
                } else {
                    let sum = 0;
                    for (let j = 0; j < maLength; j++) {
                        sum += candleData[i - j].close;
                    }
                    const maValue = sum / maLength;
                    maData.push({ time: candleData[i].time, value: maValue });
                }
            }
            return maData;
        }

        function loadInfoData(stockCode) {
            companyTitle.textContent = `Th√¥ng tin: ${stockCode}`;
            renderCompanyProfile(`Data/${stockCode}_info.csv`, 'overview-content');
            renderShareholdersTable(`Data/${stockCode}_shareholders.csv`, 'shareholders-content');
            renderOfficersTable(`Data/${stockCode}_BLD.csv`, 'officers-content');
            renderSubsidiariesTable(`Data/${stockCode}_con.csv`, 'subsidiaries-content');
            renderNewsList(`Data/${stockCode}_news10.csv`, 'news-content');

            renderFinancialReport(stockCode, 'kqkd', 'kqkd-content');
            renderFinancialReport(stockCode, 'cstc', 'cstc-content');
            renderFinancialReport(stockCode, 'lctt', 'lctt-content');
        }

        async function loadChartData() {
            const stockCode = stockCodeInput.value.trim().toUpperCase();
            const selectedInterval = intervalSelect.value;

            if (!stockCode) {
                setStatus("Vui l√≤ng nh·∫≠p m√£ c·ªï phi·∫øu.", true);
                return;
            }

            setStatus(`ƒêang t·∫£i ${stockCode} (Khung: ${selectedInterval})...`);
            initChart();
            loadInfoData(stockCode);

            try {
                const response = await fetch(`/api/get_stock_csv?symbol=${stockCode}&interval=${selectedInterval}`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `L·ªói HTTP ${response.status}` }));
                    throw new Error(errorData.error || `Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu cho ${stockCode}`);
                }
                const csvText = await response.text();

                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function (results) {
                        if (results.errors.length > 0 || results.data.length === 0) {
                            setStatus(`L·ªói x·ª≠ l√Ω ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu bi·ªÉu ƒë·ªì cho ${stockCode}.`, true);
                            if (candlestickSeries) candlestickSeries.setData([]);
                            if (volumeSeries) volumeSeries.setData([]);
                            if (maSeries) maSeries.setData([]);
                            return;
                        }

                        const validData = results.data.filter(row =>
                            row.time !== undefined && row.time !== null &&
                            ['open', 'high', 'low', 'close', 'volume'].every(key => typeof row[key] === 'number')
                        );

                        if (validData.length > 0) {
                            const candlestickData = validData.map(row => ({
                                time: row.time,
                                open: row.open,
                                high: row.high,
                                low: row.low,
                                close: row.close,
                            }));

                            const volumeData = validData.map(row => ({
                                time: row.time,
                                value: row.volume,
                                color: row.close >= row.open ? '#26a69a' : '#ff0000',
                            }));

                            const maData = calculateMovingAverageSeriesData(candlestickData, 20);

                            maSeries.setData(maData);
                            candlestickSeries.setData(candlestickData);
                            volumeSeries.setData(volumeData);

                            setStatus(`Hi·ªÉn th·ªã d·ªØ li·ªáu cho ${stockCode} (Khung: ${selectedInterval})`);
                            chart.timeScale().fitContent();
                        } else {
                            setStatus(`Kh√¥ng c√≥ d·ªØ li·ªáu bi·ªÉu ƒë·ªì h·ª£p l·ªá cho ${stockCode}.`, true);
                            if (candlestickSeries) candlestickSeries.setData([]);
                            if (volumeSeries) volumeSeries.setData([]);
                            if (maSeries) maSeries.setData([]);
                        }
                    }
                });

            } catch (error) {
                console.error("L·ªói t·∫£i d·ªØ li·ªáu bi·ªÉu ƒë·ªì:", error);
                setStatus(`L·ªói: ${error.message}`, true);
                if (candlestickSeries) candlestickSeries.setData([]);
                if (volumeSeries) volumeSeries.setData([]);
                if (maSeries) maSeries.setData([]);
            }
        }

        function initChart() {
            if (chart) {
                chart.remove();
            }
            isDrawing = false;
            startPoint = null;
            currentDrawing = null;
            allTrendLines = [];

            chart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.clientWidth,
                height: chartContainer.clientHeight,
                layout: {
                    backgroundColor: '#ffffff',
                    textColor: 'rgba(33, 56, 77, 1)',
                },
                grid: {
                    vertLines: { color: 'rgba(197, 203, 206, 0.5)' },
                    horzLines: { color: 'rgba(197, 203, 206, 0.5)' },
                },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                rightPriceScale: { borderColor: 'rgba(197, 203, 206, 0.8)' },
                timeScale: { borderColor: 'rgba(197, 203, 206, 0.8)', timeVisible: true, secondsVisible: false },
            });

            maSeries = chart.addSeries(LightweightCharts.LineSeries, { color: '#2962FF', lineWidth: 2, crosshairMarkerVisible: false });

            candlestickSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
                upColor: '#26a69a',
                downColor: '#ff0000',
                borderDownColor: '#ff0000',
                borderUpColor: '#26a69a',
                wickDownColor: '#ff0000',
                wickUpColor: '#26a69a',
            });

            candlestickSeries.priceScale().applyOptions({
                scaleMargins: {
                    top: 0.1,
                    bottom: 0.3,
                },
            });

            volumeSeries = chart.addSeries(LightweightCharts.HistogramSeries, {
                priceFormat: {
                    type: 'volume',
                },
                priceScaleId: '',
            });

            volumeSeries.priceScale().applyOptions({
                scaleMargins: {
                    top: 0.7,
                    bottom: 0,
                },
            });

            chart.subscribeClick(param => {
                if (currentDrawingTool !== 'trendline' || !param.point || !param.time) {
                    return;
                }

                const price = candlestickSeries.coordinateToPrice(param.point.y);
                if (!price) return;

                if (!isDrawing) {
                    isDrawing = true;
                    startPoint = { time: param.time, value: price };
                    currentDrawing = chart.addSeries(LightweightCharts.LineSeries, {
                        color: 'black',
                        lineWidth: 1,
                        lineStyle: LightweightCharts.LineStyle.Dashed,
                        crosshairMarkerVisible: false,
                        lastValueVisible: false,
                        priceLineVisible: false,
                    });
                    currentDrawing.setData([startPoint]);
                } else {
                    currentDrawing.setData([startPoint, { time: param.time, value: price }]);
                    allTrendLines.push(currentDrawing);
                    isDrawing = false;
                    startPoint = null;
                    currentDrawing = null;
                }
            });

            chart.subscribeCrosshairMove(param => {
                const legendEl = chartLegend;
                if (param.time === undefined || !param.point) {
                    legendEl.style.display = 'none';
                    return;
                }

                const candleData = param.seriesData.get(candlestickSeries);
                if (candleData) {
                    legendEl.style.display = 'block';
                    const volumeData = param.seriesData.get(volumeSeries);
                    const maData = param.seriesData.get(maSeries);

                    const o = candleData.open.toFixed(2);
                    const h = candleData.high.toFixed(2);
                    const l = candleData.low.toFixed(2);
                    const c = candleData.close.toFixed(2);
                    const vol = volumeData ? volumeData.value.toLocaleString('en-US') : 'N/A';
                    const maValue = maData ? maData.value.toFixed(2) : 'N/A';
                    const color = c >= o ? '#26a69a' : '#ef5350';

                    legendEl.innerHTML = `
                        <div style="font-size: 16px; margin-bottom: 4px;">
                            <strong style="color: ${color}">${stockCodeInput.value.toUpperCase()}</strong>
                            <span style="color: #2962FF; margin-left: 10px;">MA(20): ${maValue}</span>
                        </div>
                        <div>
                            <span style="color: #777;">O:</span><span style="color: ${color};">${o}</span>
                            <span style="color: #777; margin-left: 5px;">H:</span><span style="color: ${color};">${h}</span>
                            <span style="color: #777; margin-left: 5px;">L:</span><span style="color: ${color};">${l}</span>
                            <span style="color: #777; margin-left: 5px;">C:</span><span style="color: ${color};">${c}</span>
                            <span style="color: #777; margin-left: 10px;">Vol:</span><span style="color: ${color};">${vol}</span>
                        </div>
                    `;
                } else {
                    legendEl.style.display = 'none';
                }

                if (isDrawing && startPoint && currentDrawing) {
                    const price = candlestickSeries.coordinateToPrice(param.point.y);
                    if (!price) return;
                    currentDrawing.setData([startPoint, { time: param.time, value: price }]);
                }
            });
        }

        function deleteLastDrawing() {
            if (allTrendLines.length === 0) return;
            const lineToRemove = allTrendLines.pop();
            chart.removeSeries(lineToRemove);
        }

        function setActiveTool(tool) {
            if (isDrawing && currentDrawing) {
                chart.removeSeries(currentDrawing);
            }
            isDrawing = false;
            startPoint = null;
            currentDrawing = null;

            currentDrawingTool = tool;

            document.getElementById('tool-cursor').classList.remove('active');
            document.getElementById('tool-trendline').classList.remove('active');
            document.getElementById(`tool-${tool}`).classList.add('active');

            const crosshairMode = tool === 'cursor' ? LightweightCharts.CrosshairMode.Normal : LightweightCharts.CrosshairMode.Magnet;
            chart.applyOptions({
                crosshair: {
                    mode: crosshairMode,
                },
            });
        }

        function populateIntervalSelect() {
            SUPPORTED_INTERVALS.forEach(interval => {
                const option = document.createElement('option');
                option.value = interval;
                option.textContent = interval;
                if (interval === DEFAULT_INTERVAL) { option.selected = true; }
                intervalSelect.appendChild(option);
            });
        }

        function setStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.style.color = isError ? 'red' : '#333';
        }

        loadChartButton.addEventListener('click', loadChartData);
        stockCodeInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') loadChartData();
        });

        document.getElementById('tool-cursor').addEventListener('click', () => setActiveTool('cursor'));
        document.getElementById('tool-trendline').addEventListener('click', () => setActiveTool('trendline'));
        document.getElementById('tool-delete').addEventListener('click', deleteLastDrawing);


        document.querySelectorAll('input[name="kqkd-period"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const stockCode = stockCodeInput.value.trim().toUpperCase();
                if (stockCode) renderFinancialReport(stockCode, 'kqkd', 'kqkd-content');
            });
        });
        document.querySelectorAll('input[name="cstc-period"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const stockCode = stockCodeInput.value.trim().toUpperCase();
                if (stockCode) renderFinancialReport(stockCode, 'cstc', 'cstc-content');
            });
        });
        document.querySelectorAll('input[name="lctt-period"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const stockCode = stockCodeInput.value.trim().toUpperCase();
                if (stockCode) renderFinancialReport(stockCode, 'lctt', 'lctt-content');
            });
        });

        window.addEventListener('resize', () => {
            if (chart) {
                chart.resize(chartContainer.clientWidth, chartContainer.clientHeight);
            }
        });
        window.addEventListener('DOMContentLoaded', () => {
            populateIntervalSelect();
            setStatus("Nh·∫≠p m√£ c·ªï phi·∫øu v√† nh·∫•n 'T·∫£i D·ªØ Li·ªáu'");
            loadChartData();
            document.getElementById('tool-cursor').classList.add('active');
        });
    </script>
</body>

</html>