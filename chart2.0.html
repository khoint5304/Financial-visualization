<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0" />
    <title>Stock Chart & Company Info</title>
    <script type="text/javascript"
        src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body {
            padding: 0;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f7f9fa;
        }

        .controls {
            padding: 10px;
            background-color: #ffffff;
            border-bottom: 1px solid #e0e3eb;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }

        .controls input,
        .controls select,
        .controls button {
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .controls button {
            background-color: #2962FF;
            color: white;
            border-color: #2962FF;
            cursor: pointer;
            font-weight: 500;
        }

        .controls button:hover {
            background-color: #1e4dbb;
        }

        #statusMessage {
            margin-left: 10px;
            font-style: italic;
            color: #666;
        }

        .main-content {
            display: flex;
            flex-direction: row;
            flex-grow: 1;
            overflow: hidden;
        }

        #chartContainer {
            flex: 3;
            position: relative;
        }

        #infoContainer {
            flex: 1;
            padding: 15px;
            background-color: #ffffff;
            border-left: 1px solid #e0e3eb;
            overflow-y: auto;
        }

        .info-section {
            margin-bottom: 20px;
        }

        .info-section summary {
            font-weight: 600;
            font-size: 16px;
            padding: 10px;
            cursor: pointer;
            background-color: #f1f3f6;
            border-radius: 4px;
            list-style: none;
        }

        .info-section summary::-webkit-details-marker {
            display: none;
        }

        .info-section summary::before {
            content: '▶';
            margin-right: 8px;
            font-size: 12px;
            display: inline-block;
            transition: transform 0.2s;
        }

        .info-section[open]>summary::before {
            transform: rotate(90deg);
        }

        .info-content {
            padding-top: 10px;
        }

        .info-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            overflow-x: auto;
            display: block;
        }

        .info-table th,
        .info-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            white-space: nowrap;
        }

        .info-table th {
            background-color: #f8f8f8;
            font-weight: 500;
        }

        .info-table tr:nth-child(even) {
            background-color: #fdfdfd;
        }

        .period-toggle {
            margin-bottom: 10px;
            font-size: 14px;
        }

        .period-toggle label {
            margin: 0 10px 0 2px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="controls">
        <label for="stockCodeInput">Mã CP:</label>
        <input type="text" id="stockCodeInput" placeholder="VD: FPT" value="FPT" size="6">

        <label for="intervalSelect">Khung TG:</label>
        <select id="intervalSelect"></select>

        <button id="loadChartButton">Tải Dữ Liệu</button>
        <span id="statusMessage"></span>
    </div>

    <div class="main-content">
        <div id="chartContainer"></div>
        <div id="infoContainer">
            <h2 id="company-title" style="margin-top: 0;">Thông tin Công ty</h2>

            <details class="info-section" open>
                <summary>Tổng quan</summary>
                <div class="info-content" id="overview-content"></div>
            </details>

            <details class="info-section">
                <summary>Cổ đông lớn</summary>
                <div class="info-content" id="shareholders-content"></div>
            </details>

            <details class="info-section">
                <summary>Ban lãnh đạo</summary>
                <div class="info-content" id="officers-content"></div>
            </details>

            <details class="info-section">
                <summary>Công ty con & Liên kết</summary>
                <div class="info-content" id="subsidiaries-content"></div>
            </details>

            <details class="info-section">
                <summary>Báo cáo Kết quả Kinh doanh</summary>
                <div class="info-content" id="kqkd-content-wrapper">
                    <div class="period-toggle">
                        <input type="radio" id="kqkd-year" name="kqkd-period" value="year" checked>
                        <label for="kqkd-year">Năm</label>
                        <input type="radio" id="kqkd-quarter" name="kqkd-period" value="quarter">
                        <label for="kqkd-quarter">Quý</label>
                    </div>
                    <div id="kqkd-content"></div>
                </div>
            </details>

            <details class="info-section">
                <summary>Chỉ số Tài chính</summary>
                <div class="info-content" id="cstc-content-wrapper">
                    <div class="period-toggle">
                        <input type="radio" id="cstc-year" name="cstc-period" value="year" checked>
                        <label for="cstc-year">Năm</label>
                        <input type="radio" id="cstc-quarter" name="cstc-period" value="quarter">
                        <label for="cstc-quarter">Quý</label>
                    </div>
                    <div id="cstc-content"></div>
                </div>
            </details>

            <details class="info-section">
                <summary>Lưu chuyển Tiền tệ</summary>
                <div class="info-content" id="lctt-content-wrapper">
                    <div class="period-toggle">
                        <input type="radio" id="lctt-year" name="lctt-period" value="year" checked>
                        <label for="lctt-year">Năm</label>
                        <input type="radio" id="lctt-quarter" name="lctt-period" value="quarter">
                        <label for="lctt-quarter">Quý</label>
                    </div>
                    <div id="lctt-content"></div>
                </div>
            </details>

            <details class="info-section">
                <summary>Tin tức mới nhất</summary>
                <div class="info-content" id="news-content"></div>
            </details>
        </div>
    </div>

    <script type="text/javascript">
        const chartContainer = document.getElementById('chartContainer');
        const infoContainer = document.getElementById('infoContainer');
        const companyTitle = document.getElementById('company-title');
        const stockCodeInput = document.getElementById('stockCodeInput');
        const intervalSelect = document.getElementById('intervalSelect');
        const loadChartButton = document.getElementById('loadChartButton');
        const statusMessage = document.getElementById('statusMessage');

        let chart = null;
        let candlestickSeries = null;
        const SUPPORTED_INTERVALS = ['1h', '1D', '1W', '1M'];
        const DEFAULT_INTERVAL = '1D';

        function renderCompanyProfile(csvUrl, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '<p>Đang tải...</p>';

            const urlWithCacheBusting = `${csvUrl}?t=${new Date().getTime()}`;

            fetch(urlWithCacheBusting)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Không tìm thấy file: ${csvUrl.split('/').pop().split('?')[0]}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            if (results.errors.length > 0 || results.data.length === 0) {
                                container.innerHTML = '<p>Không có dữ liệu tổng quan.</p>';
                                return;
                            }

                            const profileData = results.data[0];
                            const companyProfile = profileData.company_profile || 'Chưa có thông tin.';
                            const industry = profileData.icb_name2 || 'Chưa có thông tin.';

                            let profileHTML = `<p style="text-align: justify; line-height: 1.6; font-size: 14px;">${companyProfile}</p>`;
                            profileHTML += `<p style="font-size: 14px;"><strong>Ngành:</strong> ${industry}</p>`;

                            container.innerHTML = profileHTML;
                        }
                    });
                })
                .catch(error => {
                    console.error(`Lỗi khi tải ${containerId}:`, error);
                    container.innerHTML = `<p style="color: red;">${error.message}</p>`;
                });
        }

        function renderShareholdersTable(csvUrl, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '<p>Đang tải...</p>';

            const urlWithCacheBusting = `${csvUrl}?t=${new Date().getTime()}`;

            fetch(urlWithCacheBusting)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Không tìm thấy file: ${csvUrl.split('/').pop().split('?')[0]}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            if (results.errors.length > 0 || results.data.length === 0) {
                                container.innerHTML = '<p>Không có dữ liệu.</p>';
                                return;
                            }
                            const data = results.data;

                            let tableHTML = '<table class="info-table"><thead><tr>';
                            tableHTML += '<th>Cổ đông</th>';
                            tableHTML += '<th>Số lượng cổ phiếu</th>';
                            tableHTML += '<th>Tỉ lệ cổ phiếu</th>';
                            tableHTML += '<th>Ngày cập nhật</th>';
                            tableHTML += '</tr></thead><tbody>';

                            data.forEach(row => {
                                const quantity = parseFloat(row.quantity);
                                const percent = parseFloat(row.share_own_percent);
                                tableHTML += '<tr>';
                                tableHTML += `<td>${row.share_holder || ''}</td>`;
                                tableHTML += `<td>${!isNaN(quantity) ? quantity.toLocaleString('vi-VN') : ''}</td>`;
                                tableHTML += `<td>${!isNaN(percent) ? (percent * 100).toFixed(2) + '%' : ''}</td>`;
                                tableHTML += `<td>${row.update_date || ''}</td>`;
                                tableHTML += '</tr>';
                            });

                            tableHTML += '</tbody></table>';
                            container.innerHTML = tableHTML;
                        }
                    });
                })
                .catch(error => {
                    console.error(`Lỗi khi tải ${containerId}:`, error);
                    container.innerHTML = `<p style="color: red;">${error.message}</p>`;
                });
        }

        function renderOfficersTable(csvUrl, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '<p>Đang tải...</p>';

            const urlWithCacheBusting = `${csvUrl}?t=${new Date().getTime()}`;

            fetch(urlWithCacheBusting)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Không tìm thấy file: ${csvUrl.split('/').pop().split('?')[0]}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            if (results.errors.length > 0 || results.data.length === 0) {
                                container.innerHTML = '<p>Không có dữ liệu.</p>';
                                return;
                            }
                            const data = results.data;

                            let tableHTML = '<table class="info-table"><thead><tr>';
                            tableHTML += '<th>Tên</th>';
                            tableHTML += '<th>Vị trí</th>';
                            tableHTML += '<th>Số lượng</th>';
                            tableHTML += '<th>Tỉ lệ sở hữu</th>';
                            tableHTML += '<th>Thời gian cập nhật</th>';
                            tableHTML += '</tr></thead><tbody>';

                            data.forEach(row => {
                                const quantity = parseFloat(row.quantity);
                                const percent = parseFloat(row.officer_own_percent);
                                tableHTML += '<tr>';
                                tableHTML += `<td>${row.officer_name || ''}</td>`;
                                tableHTML += `<td>${row.officer_position || ''}</td>`;
                                tableHTML += `<td>${!isNaN(quantity) ? quantity.toLocaleString('vi-VN') : ''}</td>`;
                                tableHTML += `<td>${!isNaN(percent) ? (percent * 100).toFixed(4) + '%' : ''}</td>`;
                                tableHTML += `<td>${row.update_date || ''}</td>`;
                                tableHTML += '</tr>';
                            });

                            tableHTML += '</tbody></table>';
                            container.innerHTML = tableHTML;
                        }
                    });
                })
                .catch(error => {
                    console.error(`Lỗi khi tải ${containerId}:`, error);
                    container.innerHTML = `<p style="color: red;">${error.message}</p>`;
                });
        }

        function renderSubsidiariesTable(csvUrl, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '<p>Đang tải...</p>';

            const urlWithCacheBusting = `${csvUrl}?t=${new Date().getTime()}`;

            fetch(urlWithCacheBusting)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Không tìm thấy file: ${csvUrl.split('/').pop().split('?')[0]}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            if (results.errors.length > 0 || results.data.length === 0) {
                                container.innerHTML = '<p>Không có dữ liệu.</p>';
                                return;
                            }
                            const data = results.data;

                            let tableHTML = '<table class="info-table"><thead><tr>';
                            tableHTML += '<th>Tên công ty</th>';
                            tableHTML += '<th>Loại</th>';
                            tableHTML += '<th>Tỉ lệ sở hữu</th>';
                            tableHTML += '</tr></thead><tbody>';

                            data.forEach(row => {
                                const percent = parseFloat(row.ownership_percent);
                                tableHTML += '<tr>';
                                tableHTML += `<td>${row.organ_name || ''}</td>`;
                                tableHTML += `<td>${row.type || ''}</td>`;
                                tableHTML += `<td>${!isNaN(percent) ? (percent * 100).toFixed(2) + '%' : ''}</td>`;
                                tableHTML += '</tr>';
                            });

                            tableHTML += '</tbody></table>';
                            container.innerHTML = tableHTML;
                        }
                    });
                })
                .catch(error => {
                    console.error(`Lỗi khi tải ${containerId}:`, error);
                    container.innerHTML = `<p style="color: red;">${error.message}</p>`;
                });
        }

        function renderNewsList(csvUrl, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '<p>Đang tải...</p>';

            const urlWithCacheBusting = `${csvUrl}?t=${new Date().getTime()}`;

            fetch(urlWithCacheBusting)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Không tìm thấy file: ${csvUrl.split('/').pop().split('?')[0]}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            if (results.errors.length > 0 || results.data.length === 0) {
                                container.innerHTML = '<p>Không có dữ liệu.</p>';
                                return;
                            }
                            const data = results.data;

                            let listHTML = '<ul style="padding-left: 20px; margin: 0; list-style-type: none;">';
                            data.forEach(row => {
                                const title = row.news_title;
                                const link = row.news_source_link;
                                if (title && link) {
                                    listHTML += `<li style="margin-bottom: 12px; font-size: 14px;"><a href="${link}" target="_blank" style="text-decoration: none; color: #0056b3;">${title}</a></li>`;
                                }
                            });
                            listHTML += '</ul>';
                            container.innerHTML = listHTML;
                        }
                    });
                })
                .catch(error => {
                    console.error(`Lỗi khi tải ${containerId}:`, error);
                    container.innerHTML = `<p style="color: red;">${error.message}</p>`;
                });
        }

        function renderFinancialReport(stockCode, reportAbbr, containerId) {
            const period = document.querySelector(`input[name="${reportAbbr}-period"]:checked`).value;
            const filename = `Data/${stockCode}_${reportAbbr}_${period}.csv`;
            renderFinancialTable(filename, containerId);
        }

        function renderFinancialTable(csvUrl, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '<p>Đang tải...</p>';

            const urlWithCacheBusting = `${csvUrl}?t=${new Date().getTime()}`;

            fetch(urlWithCacheBusting)
                .then(response => {
                    if (!response.ok) { throw new Error(`Không tìm thấy file: ${csvUrl.split('/').pop().split('?')[0]}`); }
                    return response.text();
                })
                .then(csvText => {
                    Papa.parse(csvText, {
                        header: false,
                        skipEmptyLines: true,
                        complete: (results) => {
                            const allRows = results.data;
                            if (allRows.length < 2) {
                                container.innerHTML = '<p>Không có dữ liệu hợp lệ.</p>';
                                return;
                            }

                            const headers = allRows[1];
                            const dataRows = allRows.slice(2);

                            let tableHTML = '<table class="info-table"><thead><tr>';
                            headers.forEach(header => {
                                tableHTML += `<th>${header}</th>`;
                            });
                            tableHTML += '</tr></thead><tbody>';

                            dataRows.forEach(row => {
                                tableHTML += '<tr>';
                                row.forEach(cell => {
                                    tableHTML += `<td>${cell || ''}</td>`;
                                });
                                tableHTML += '</tr>';
                            });

                            tableHTML += '</tbody></table>';
                            container.innerHTML = tableHTML;
                        }
                    });
                })
                .catch(error => {
                    console.error(`Lỗi khi tải ${containerId}:`, error);
                    container.innerHTML = `<p style="color: red;">${error.message}</p>`;
                });
        }

        function loadInfoData(stockCode) {
            companyTitle.textContent = `Thông tin: ${stockCode}`;
            renderCompanyProfile(`Data/${stockCode}_info.csv`, 'overview-content');
            renderShareholdersTable(`Data/${stockCode}_shareholders.csv`, 'shareholders-content');
            renderOfficersTable(`Data/${stockCode}_BLD.csv`, 'officers-content');
            renderSubsidiariesTable(`Data/${stockCode}_con.csv`, 'subsidiaries-content');
            renderNewsList(`Data/${stockCode}_news10.csv`, 'news-content');

            renderFinancialReport(stockCode, 'kqkd', 'kqkd-content');
            renderFinancialReport(stockCode, 'cstc', 'cstc-content');
            renderFinancialReport(stockCode, 'lctt', 'lctt-content');
        }

        async function loadChartData() {
            const stockCode = stockCodeInput.value.trim().toUpperCase();
            const selectedInterval = intervalSelect.value;

            if (!stockCode) {
                setStatus("Vui lòng nhập mã cổ phiếu.", true);
                return;
            }

            setStatus(`Đang tải ${stockCode} (Khung: ${selectedInterval})...`);
            initChart();
            loadInfoData(stockCode);

            try {
                const response = await fetch(`/api/get_stock_csv?symbol=${stockCode}&interval=${selectedInterval}`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `Lỗi HTTP ${response.status}` }));
                    throw new Error(errorData.error || `Không thể tải dữ liệu cho ${stockCode}`);
                }
                const csvText = await response.text();

                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function (results) {
                        if (results.errors.length > 0 || results.data.length === 0) {
                            setStatus(`Lỗi xử lý hoặc không có dữ liệu biểu đồ cho ${stockCode}.`, true);
                            if (candlestickSeries) candlestickSeries.setData([]);
                            return;
                        }

                        const chartData = results.data.map(row => ({
                            time: row.time,
                            open: row.open,
                            high: row.high,
                            low: row.low,
                            close: row.close
                        })).filter(item =>
                            item.time !== undefined && item.time !== null &&
                            [item.open, item.high, item.low, item.close].every(v => typeof v === 'number')
                        );

                        if (chartData.length > 0) {
                            candlestickSeries.setData(chartData);
                            setStatus(`Hiển thị dữ liệu cho ${stockCode} (Khung: ${selectedInterval})`);
                            chart.timeScale().fitContent();
                        } else {
                            setStatus(`Không có dữ liệu biểu đồ hợp lệ cho ${stockCode}.`, true);
                            if (candlestickSeries) candlestickSeries.setData([]);
                        }
                    }
                });

            } catch (error) {
                console.error("Lỗi tải dữ liệu biểu đồ:", error);
                setStatus(`Lỗi: ${error.message}`, true);
                if (candlestickSeries) candlestickSeries.setData([]);
            }
        }

        function initChart() {
            if (chart) {
                chart.remove();
            }
            chart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.clientWidth,
                height: chartContainer.clientHeight,
                layout: {
                    backgroundColor: '#ffffff',
                    textColor: 'rgba(33, 56, 77, 1)',
                },
                grid: {
                    vertLines: { color: 'rgba(197, 203, 206, 0.5)' },
                    horzLines: { color: 'rgba(197, 203, 206, 0.5)' },
                },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                rightPriceScale: { borderColor: 'rgba(197, 203, 206, 0.8)' },
                timeScale: { borderColor: 'rgba(197, 203, 206, 0.8)', timeVisible: true, secondsVisible: false },
            });

            candlestickSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderDownColor: '#ef5350',
                borderUpColor: '#26a69a',
                wickDownColor: '#ef5350',
                wickUpColor: '#26a69a',
            });
        }

        function populateIntervalSelect() {
            SUPPORTED_INTERVALS.forEach(interval => {
                const option = document.createElement('option');
                option.value = interval;
                option.textContent = interval;
                if (interval === DEFAULT_INTERVAL) { option.selected = true; }
                intervalSelect.appendChild(option);
            });
        }

        function setStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.style.color = isError ? 'red' : '#333';
        }

        loadChartButton.addEventListener('click', loadChartData);
        stockCodeInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') loadChartData();
        });

        document.querySelectorAll('input[name="kqkd-period"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const stockCode = stockCodeInput.value.trim().toUpperCase();
                if (stockCode) renderFinancialReport(stockCode, 'kqkd', 'kqkd-content');
            });
        });
        document.querySelectorAll('input[name="cstc-period"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const stockCode = stockCodeInput.value.trim().toUpperCase();
                if (stockCode) renderFinancialReport(stockCode, 'cstc', 'cstc-content');
            });
        });
        document.querySelectorAll('input[name="lctt-period"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const stockCode = stockCodeInput.value.trim().toUpperCase();
                if (stockCode) renderFinancialReport(stockCode, 'lctt', 'lctt-content');
            });
        });

        window.addEventListener('resize', () => {
            if (chart) {
                chart.resize(chartContainer.clientWidth, chartContainer.clientHeight);
            }
        });
        window.addEventListener('DOMContentLoaded', () => {
            populateIntervalSelect();
            setStatus("Nhập mã cổ phiếu và nhấn 'Tải Dữ Liệu'");
            loadChartData();
        });
    </script>
</body>

</html>